import { Scene } from 'phaser'
import Floor from '../utils/floor'
import Wall from '../utils/wall'
import Item from '../utils/item'
import store from '../store'
import Character from '../utils/character'
import Monster from '../utils/monster'
export default class PlayScene extends Scene {
  constructor () {
    super({ key: 'PlayScene' })
    this.centerX = screen.width / 2
    this.centerY = screen.height / 2
    this.firstFloor = null
    this.secondFloor = null
    this.wall = null
  }
  init () {
    this.Character_instance = new Character(this, 40, 40, 'character')
  }
  preload () {
  }
  async create () {
    store.dispatch('showNotification', { message: 'GAME START' })
    this.cameras.main.setZoom(0.7)
    const shadow = this.add.image(this.centerX, this.centerY + 900, 'tile-shadow').setOrigin(0.5, 1).setDepth(0.1)
    this.wall = new Wall(this, {
      x: this.centerX,
      y: this.centerY + 295,
      texture: 'wall',
      depth: 0
    }).setOrigin(0.5, 1)



    // const firstFloor_collider = [[0, 0], [0, 1], [0, 2], [0, 3], [0, 4]]
    this.firstFloor = new Floor(this, { column: 9, row: 9, floor: 1 })
    this.secondFloor = new Floor(this, { column: 7, row: 3, floor: 2 })

    // item setting
    this.pliers = new Item(this, 'pliers', 'ground', { column: 9, row: 6, floor: 1 }).setOrigin(0.5, 1)
    this.table = new Item(this, 'table', 'ground', { column: 1, row: 8, floor: 1 }).setOrigin(0.5, 1)
    this.window = new Item(this, 'window', 'wall', { depth: 1000, x: this.centerX - 192 * 1.5, y: this.centerY + 400 }).setOrigin(0.5, 1)
    this.groove = new Item(this, 'groove', 'wall', { depth: 1000, x: this.centerX + 192 * 2.25, y: this.centerY - 192, column: 5, row: 1, floor: 2 }).setOrigin(0.5, 1)
    this.curtain = new Item(this, 'curtain', 'wall', { depth: 560, x: this.centerX - 192 * 0.8, y: this.centerY - 192 * 1.2, column: 1, row: 2, floor: 2 }).setOrigin(0.5, 1)
    this.pipe = new Item(this, 'pipe', 'wall', { depth: 1000, x: this.centerX + 192 * 1.2, y: this.centerY - 192 * 2 }).setOrigin(0.5, 1)
    this.nail = new Item(this, 'nail', 'wall', { depth: 1000, x: this.centerX + 192 * 1.3, y: this.centerY + 192 * 1.3 }).setOrigin(0.5, 1)
    this.nail.setInteractive().on('pointerdown', () => {
      if (!store.state.items.includes('ladder')) {
        return
      }
      this.nail.setTexture('rope')
      this.tweens.add({
        targets: this.nail,
        alpha: 0,
        delay: 500,
        duration: 2000,
      })
      store.dispatch('useItem', { in: 'ladder', out: 'climb' })
    })

    this.exit = this.add.sprite(this.centerX + 192 * 4, this.centerY + 192 * 1.37, 'openExit').setOrigin(0.5, 1).setDepth(1000).setVisible(false)
    this.createAnim('openExitAnim', 'exit', 'open-exit', 18)
    this.fakeDoor = new Item(this, 'fake-door', 'wall', { depth: 2000, x: this.centerX - 192 * 1.7, y: this.centerY + 192 * 3 }).setOrigin(0.5, 1)
    this.reflection = new Item(this, 'reflection', 'wall', { depth: 1000, x: this.centerX - 192 * 1.1, y: this.centerY + 192 * 1.5 }).setOrigin(0, 1).setVisible(false)
    this.point = new Item(this, 'point', 'ground', { column: 4, row: 6, floor: 1 }).setOrigin(0.5, 1).setTexture('tile-empty')
    this.littleMonster = new Item(this, 'little-monster', 'ground', { column: 3, row: 1, floor: 2 }).setOrigin(0.5, 1)

    this.bigMonster = new Monster(this, this.centerX + 192 * 3.7, this.centerY + 192 * 1.4, 8, 0).setOrigin(0.5, 1)

    this.exit.play('openExitAnim')

    this.mountDragEvent()
    this.mountWheelEvent()
  }

  mountDragEvent () {
    const pinch = this.rexGestures.add.pinch()
    const camera = this.cameras.main
    pinch
      .on('drag1', function (pinch) {
        const drag1Vector = pinch.drag1Vector
        camera.scrollX -= drag1Vector.x / camera.zoom
        camera.scrollY -= drag1Vector.y / camera.zoom
      })
  }
  mountWheelEvent () {
    this.deltaY = 0
    this.input.on('wheel', (pointer, gameObject, deltaX, deltaY, deltaZ) => {
      let zoom = this.cameras.main.zoom + deltaY / 1000
      if (zoom <= 0.3) {
        zoom = 0.3
      } else if (zoom >= 3) {
        zoom = 3
      }
      this.cameras.main.setZoom(zoom)
    })
  }
  createAnim (key, name, atlas, endFrame) {
    const config = {
      key: key,
      frames: this.anims.generateFrameNames(atlas, {
        prefix: name + '_',
        suffix: '.png',
        start: 0,
        zeroPad: 3,
        end: endFrame
      }),
      frameRate: 25
    }
    this.anims.create(config)
  }
}
